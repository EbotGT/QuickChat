<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuickChat â€” Minimal Stable</title>
  <style>
    body{background:#111;color:#eee;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;margin:0;padding:20px;display:flex;justify-content:center}
    .container{max-width:860px;width:100%}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input,textarea,button{font:inherit;padding:8px 12px;border-radius:10px;border:1px solid #2a2a35;background:#12121a;color:#eee}
    button{cursor:pointer;background:#14141e}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .chat{border:1px solid #2a2a35;border-radius:14px;display:flex;flex-direction:column;height:70vh;overflow:hidden;background:#17171f;margin-top:10px}
    .scroller{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
    .mine{align-self:flex-end;background:#dfeaff;color:#0b0b12;padding:8px 10px;border-radius:12px;max-width:75%}
    .theirs{align-self:flex-start;background:#1f1f2a;padding:8px 10px;border-radius:12px;max-width:75%}
    .meta{font-size:11px;opacity:.7;margin-bottom:4px}
    .composer{display:flex;gap:8px;padding:10px;border-top:1px solid #2a2a35}
    .small{color:#aaa;font-size:12px}
    .err{color:#ff7a7a;margin-top:8px;min-height:1em}
    /* modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;padding:20px;z-index:50}
    .panel{background:#12121a;border:1px solid #2a2a35;border-radius:16px;max-width:420px;width:100%;padding:16px}
  </style>
</head>
<body>
  <div class="container">
    <h1>QuickChat â€” Minimal Stable</h1>
    <div class="row" style="margin-bottom:10px">
      <span>You: <b id="meLabel">â€”</b></span>
      <button id="changeName">Change</button>
      <input id="them" placeholder="Recipient name" />
      <button id="clearBtn">Clear</button>
    </div>

    <div class="chat">
      <div id="scroller" class="scroller"><div class="small">Enter a recipient to start.</div></div>
      <div class="composer">
        <textarea id="draft" rows="2" placeholder="Type your messageâ€¦"></textarea>
        <button id="sendBtn">Send</button>
      </div>
    </div>

    <div id="error" class="err"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" crossorigin="anonymous"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // Hardcoded creds (your project)
    const SUPABASE_URL = "https://ztxnsioiripexprudlkk.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0eG5zaW9pcmlwZXhwcnVkbGtrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0MjQ4NjYsImV4cCI6MjA3MjAwMDg2Nn0.vRB-frSRNNnMLSYOp3PR1RS1Qq4lmCwB2-KVdqRMEog";

    // Elements
    const themEl   = document.getElementById('them');
    const draftEl  = document.getElementById('draft');
    const sendBtn  = document.getElementById('sendBtn');
    const clearBtn = document.getElementById('clearBtn');
    const scroller = document.getElementById('scroller');
    const errorEl  = document.getElementById('error');
    const meLabel  = document.getElementById('meLabel');
    const changeName = document.getElementById('changeName');

    // State
    let client = null;
    let me = null;
    let channel = null;
    let currentKey = '';
    let messages = [];

    const keyFor = (a,b)=>[a.trim().toLowerCase(), b.trim().toLowerCase()].sort().join('|');
    const t = ts => new Date(ts).toLocaleString();
    const setErr = m => errorEl.textContent = m || '';

    function updateButtons(){
      const ready = !!(me && themEl.value.trim());
      sendBtn.disabled  = !ready || !draftEl.value.trim();
      clearBtn.disabled = !ready;
    }

    function render(){
      scroller.innerHTML='';
      if(!messages.length){
        const d=document.createElement('div'); d.className='small'; d.textContent='No messages yet. Say hi! ðŸ‘‹';
        scroller.appendChild(d);
      }else{
        const meL = me.toLowerCase();
        for(const m of messages){
          const mine = (m.sender||'').toLowerCase()===meL;
          const b = document.createElement('div'); b.className= mine?'mine':'theirs';
          const meta=document.createElement('div'); meta.className='meta'; meta.textContent=(mine?'You':m.sender)+' â€¢ '+t(m.created_at);
          const text=document.createElement('div'); text.textContent=m.body;
          b.appendChild(meta); b.appendChild(text); scroller.appendChild(b);
        }
      }
      scroller.scrollTop = scroller.scrollHeight;
      updateButtons();
    }

    async function ensureClient(){
      if(client) return true;
      try{
        client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        return true;
      }catch(e){
        setErr('createClient failed: '+ e.message);
        return false;
      }
    }

    async function reload(){
      setErr('');
      if(!me || !themEl.value.trim()){ messages=[]; render(); return; }
      if(!await ensureClient()) return;
      currentKey = keyFor(me, themEl.value.trim());
      const { data, error } = await client.from('messages').select('*').eq('convo_key', currentKey).order('created_at', { ascending: true });
      if(error){ setErr('Load error: '+ error.message); messages=[]; render(); return; }
      messages = data || []; render();
      if(channel){ client.removeChannel(channel); channel=null; }
      channel = client.channel('room:'+currentKey)
        .on('postgres_changes', { event:'INSERT', schema:'public', table:'messages', filter:`convo_key=eq.${currentKey}` }, payload=>{ messages.push(payload.new); render(); })
        .subscribe();
    }

    async function send(){
      setErr('');
      if(!me || !themEl.value.trim() || !draftEl.value.trim()) return;
      if(!await ensureClient()) return;
      const body = draftEl.value.trim();
      const { error } = await client.from('messages').insert({
        convo_key: currentKey || keyFor(me, themEl.value.trim()),
        sender: me,
        recipient: themEl.value.trim(),
        body
      });
      if(error){ setErr('Send failed: '+ error.message); return; }
      draftEl.value=''; updateButtons();
    }

    async function clearConvo(){
      setErr('');
      if(!me || !themEl.value.trim()) return;
      if(!await ensureClient()) return;
      if(!confirm('Clear this conversation from the database?')) return;
      const k = keyFor(me, themEl.value.trim());
      const { error } = await client.from('messages').delete().eq('convo_key', k);
      if(error){ setErr('Clear failed: '+ error.message); return; }
      messages=[]; render();
    }

    function askName(){
      const modal = document.createElement('div');
      modal.className='modal';
      modal.innerHTML = `
        <div class="panel">
          <div style="font-weight:700">Set your name</div>
          <input id="nameInput" placeholder="e.g., Ethan" style="width:100%;margin-top:8px" />
          <div class="row" style="justify-content:flex-end;margin-top:10px">
            <button id="saveNameBtn">Save</button>
          </div>
          <div class="small" style="margin-top:6px">Saved locally so you only enter it once.</div>
        </div>`;
      document.body.appendChild(modal);
      const nameInput = modal.querySelector('#nameInput');
      const saveBtn = modal.querySelector('#saveNameBtn');
      nameInput.focus();
      function save(){
        const v = (nameInput.value||'').trim();
        if(!v) return;
        me = v;
        localStorage.setItem('quickchat:me', me);
        meLabel.textContent = me;
        document.body.removeChild(modal);
        reload();
      }
      saveBtn.addEventListener('click', save);
      nameInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); save(); }});
    }

    // ===== Init (ALWAYS ask name on first load) =====
    me = localStorage.getItem('quickchat:me') || null;
    meLabel.textContent = me || 'â€”';
    if(!me){ askName(); } // <- will pop immediately on first load
    updateButtons();

    // ===== Events =====
    themEl.addEventListener('input', ()=>{ reload(); updateButtons(); });
    draftEl.addEventListener('input', updateButtons);
    draftEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }});
    sendBtn.addEventListener('click', send);
    clearBtn.addEventListener('click', clearConvo);
    changeName.addEventListener('click', ()=> askName());
  }); // DOMContentLoaded
  </script>
</body>
</html>
