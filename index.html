<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuickChat â€” Supabase (with collapsible debug)</title>
  <style>
    :root{--bg:#111;--panel:#17171f;--line:#2a2a35;--text:#eee;--muted:#aaa;--ok:#36d399;--bad:#ff7a7a}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;display:flex;justify-content:center;padding:20px}
    .container{max-width:860px;width:100%}
    h1{margin:0 0 10px;display:flex;align-items:center;gap:10px}
    input,textarea,button{font:inherit;padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#12121a;color:var(--text)}
    input::placeholder,textarea::placeholder{color:#777}
    button{cursor:pointer;background:#14141e}
    button:hover{background:#1a1a25}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .chip{border:1px solid var(--line);padding:6px 10px;border-radius:999px;background:#14141e}
    .chat{border:1px solid var(--line);border-radius:14px;display:flex;flex-direction:column;height:70vh;overflow:hidden;background:var(--panel)}
    .scroller{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
    .mine{align-self:flex-end;background:#dfeaff;color:#0b0b12;padding:8px 10px;border-radius:12px;max-width:75%}
    .theirs{align-self:flex-start;background:#1f1f2a;padding:8px 10px;border-radius:12px;max-width:75%}
    .meta{font-size:11px;opacity:.7;margin-bottom:4px}
    .composer{display:flex;gap:8px;padding:10px;border-top:1px solid var(--line)}
    .composer textarea{flex:1}
    .error{color:var(--bad);font-size:13px;margin:6px;min-height:1em}
    .badge{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--line);border-radius:999px;padding:4px 10px;background:#14141e;font-size:12px}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--bad)}
    .dot.ok{background:var(--ok)}

    /* Collapsible debug panel */
    #debugWrap{position:fixed;left:0;right:0;bottom:0;display:none;z-index:60}
    #debug{margin:0 auto 0 auto;max-width:980px;border:1px solid var(--line);background:#0f0f14;color:#ddd;border-radius:12px 12px 0 0;overflow:hidden}
    #debugHeader{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#13131b;border-bottom:1px solid var(--line)}
    #debugHeader .title{font-weight:600;font-size:14px}
    #debugBody{padding:10px 12px;display:none}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;white-space:pre-wrap}
    .pill{border:1px solid var(--line);padding:2px 8px;border-radius:999px;background:#15151f}
    .btn{padding:6px 10px;border-radius:8px;border:1px solid var(--line);background:#181825;color:#eee;cursor:pointer}
    .btn:hover{background:#1f1f2a}
  </style>
</head>
<body>
  <div class="container">
    <h1>
      QuickChat â€” Supabase
      <span class="badge"><span id="rtDot" class="dot"></span><span id="rtText">offline</span></span>
    </h1>

    <div class="row" style="margin-bottom:10px">
      <span class="chip">You: <b id="meLabel">â€”</b></span>
      <button id="changeNameBtn" title="Change your name">Change</button>
      <input id="them" placeholder="Recipient name" />
      <button id="clearBtn" title="Delete this conversation from DB">Clear</button>
    </div>

    <div class="chat">
      <div class="scroller" id="scroller"><div style="color:#aaa;font-size:12px">Enter a recipient name to start chatting.</div></div>
      <div class="composer">
        <textarea id="draft" rows="2" placeholder="Type your messageâ€¦"></textarea>
        <button id="sendBtn">Send</button>
      </div>
    </div>

    <div id="error" class="error"></div>
  </div>

  <!-- Collapsible Debug (hidden until error) -->
  <div id="debugWrap">
    <div id="debug">
      <div id="debugHeader">
        <div class="title">Debug info</div>
        <div class="row">
          <span class="pill" id="dbgUrl"></span>
          <span class="pill" id="dbgRt"></span>
          <button id="dbgToggle" class="btn" aria-expanded="false">Show</button>
        </div>
      </div>
      <div id="debugBody">
        <div class="mono" id="dbgMsg"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" crossorigin="anonymous"></script>
  <script>
    // Injected from Python at save-time:
    const RAW_URL = "https://ztxnsioiripexprudlkk.supabase.co";
    const RAW_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0eG5zaW9pcmlwZXhwcnVkbGtrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0MjQ4NjYsImV4cCI6MjA3MjAwMDg2Nn0.vRB-frSRNNnMLSYOp3PR1RS1Qq4lmCwB2-KVdqRMEog";

    function normalizeUrl(u){
      let s = (u||'').trim();
      if(!s) return s;
      if(!/^https?:\/\//i.test(s)) s = 'https://'+s;
      s = s.replace(/\/$/, '');
      return s;
    }

    const SUPABASE_URL = normalizeUrl(RAW_URL);
    const SUPABASE_KEY = RAW_KEY.trim();
    const REALTIME_URL = SUPABASE_URL ? SUPABASE_URL + '/realtime/v1' : '';

    // DOM
    const themEl = document.getElementById('them');
    const draftEl = document.getElementById('draft');
    const sendBtn = document.getElementById('sendBtn');
    const clearBtn = document.getElementById('clearBtn');
    const scroller = document.getElementById('scroller');
    const errorEl = document.getElementById('error');
    const meLabel = document.getElementById('meLabel');
    const changeNameBtn = document.getElementById('changeNameBtn');
    const rtDot = document.getElementById('rtDot');
    const rtText = document.getElementById('rtText');

    // Debug elements
    const debugWrap = document.getElementById('debugWrap');
    const dbgUrl = document.getElementById('dbgUrl');
    const dbgRt = document.getElementById('dbgRt');
    const dbgMsg = document.getElementById('dbgMsg');
    const dbgToggle = document.getElementById('dbgToggle');
    const dbgBody = document.getElementById('debugBody');

    // State
    let client=null, channel=null, me=null, currentKey=''; let messages=[];

    // Helpers
    const niceTime = ts => new Date(ts).toLocaleString();
    const keyFor = (a,b)=>[a.trim().toLowerCase(), b.trim().toLowerCase()].sort().join('|');
    function setError(msg){
      errorEl.textContent = msg || '';
      if(msg){
        // Show debug panel (collapsed)
        debugWrap.style.display = 'block';
        dbgUrl.textContent = 'URL: ' + (SUPABASE_URL || '(empty)');
        dbgRt.textContent  = 'Realtime: ' + (REALTIME_URL || '(empty)');
        dbgMsg.textContent = msg;
      }
    }
    function setRtStatus(ok){
      rtDot.classList.toggle('ok', !!ok); rtText.textContent = ok ? 'online' : 'offline';
    }
    function updateButtons(){
      const ready = !!(me && themEl.value.trim());
      sendBtn.disabled = !ready || !draftEl.value.trim();
      clearBtn.disabled = !ready;
    }
    function render(){
      scroller.innerHTML='';
      if(!messages.length){
        const d=document.createElement('div'); d.style.cssText='color:#aaa;font-size:12px'; d.textContent='No messages yet. Say hi! ðŸ‘‹';
        scroller.appendChild(d);
      }else{
        const meL = me.toLowerCase();
        for(const m of messages){
          const mine=(m.sender||'').toLowerCase()===meL;
          const bubble=document.createElement('div'); bubble.className=mine?'mine':'theirs';
          const meta=document.createElement('div'); meta.className='meta'; meta.textContent=(mine?'You':m.sender)+' â€¢ '+niceTime(m.created_at);
          const text=document.createElement('div'); text.textContent=m.body;
          bubble.appendChild(meta); bubble.appendChild(text); scroller.appendChild(bubble);
        }
      }
      scroller.scrollTop = scroller.scrollHeight; updateButtons();
    }

    async function ensureClient(){
      if(client) return true;
      try{ client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY); return true; }
      catch(e){ setError('createClient() failed: '+ e.message); return false; }
    }

    async function reload(){
      setError('');
      if(!me || !themEl.value.trim()){ messages=[]; render(); return; }
      if(!await ensureClient()) return;
      currentKey = keyFor(me, themEl.value.trim());
      const {{ data, error }} = await client.from('messages').select('*').eq('convo_key', currentKey).order('created_at', {{ ascending: true }});
      if(error){ setError('Load error: '+ error.message); messages=[]; render(); return; }
      messages = data || []; render();
      if(channel){ client.removeChannel(channel); channel=null; setRtStatus(false); }
      channel = client.channel('room:'+currentKey)
        .on('postgres_changes', {{ event:'INSERT', schema:'public', table:'messages', filter:`convo_key=eq.${{currentKey}}` }}, payload=>{ messages.push(payload.new); render(); })
        .subscribe((status)=>{ setRtStatus(status==='SUBSCRIBED'); });
    }

    async function send(){
      setError('');
      if(!me || !themEl.value.trim() || !draftEl.value.trim()) return;
      if(!await ensureClient()) return;
      const body = draftEl.value.trim();
      const {{ error }} = await client.from('messages').insert({
        convo_key: currentKey || keyFor(me, themEl.value.trim()),
        sender: me, recipient: themEl.value.trim(), body
      });
      if(error) return setError('Send failed: '+ error.message);
      draftEl.value=''; updateButtons();
    }

    async function clearConvo(){
      setError('');
      if(!me || !themEl.value.trim()) return;
      if(!await ensureClient()) return;
      if(!confirm('Clear this conversation from the database?')) return;
      const key = keyFor(me, themEl.value.trim());
      const {{ error }} = await client.from('messages').delete().eq('convo_key', key);
      if(error) return setError('Clear failed: '+ error.message);
      messages=[]; render();
    }

    function askName(initial=''){
      const modal = document.createElement('div');
      modal.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;padding:20px';
      modal.innerHTML = `
        <div style="background:#12121a;border:1px solid var(--line);border-radius:16px;max-width:420px;width:100%;padding:16px">
          <div style="font-weight:700">Set your name</div>
          <input id="nameInput" placeholder="e.g., Ethan" value="" style="width:100%;margin-top:8px" />
          <div class="row" style="justify-content:flex-end;margin-top:10px">
            <button id="saveNameBtn">Save</button>
          </div>
          <div style="color:#aaa;font-size:12px;margin-top:6px">Saved locally so you only enter it once.</div>
        </div>`;
      document.body.appendChild(modal);
      const nameInput = modal.querySelector('#nameInput');
      const saveBtn = modal.querySelector('#saveNameBtn');
      nameInput.focus();
      function save(){
        const v = (nameInput.value||'').trim(); if(!v) return;
        me = v; localStorage.setItem('quickchat:me', me); meLabel.textContent = me; document.body.removeChild(modal); reload();
      }
      saveBtn.addEventListener('click', save);
      nameInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); save(); }});
    }

    // Debug toggle logic
    dbgToggle.addEventListener('click', ()=>{
      const open = dbgBody.style.display !== 'none';
      if(open){ dbgBody.style.display = 'none'; dbgToggle.textContent='Show'; dbgToggle.setAttribute('aria-expanded','false'); }
      else{ dbgBody.style.display = 'block'; dbgToggle.textContent='Hide'; dbgToggle.setAttribute('aria-expanded','true'); }
    });
    // Start collapsed
    dbgBody.style.display = 'none';

    // Init
    (function(){
      // Fill header pills once
      dbgUrl.textContent = 'URL: ' + (SUPABASE_URL || '(empty)');
      dbgRt .textContent = 'Realtime: ' + (REALTIME_URL || '(empty)');
      me = localStorage.getItem('quickchat:me') || null;
      meLabel.textContent = me || 'â€”';
      if(!me) askName('');
      updateButtons();
    })();

    // Events
    themEl.addEventListener('input', ()=>{ reload(); updateButtons(); });
    draftEl.addEventListener('input', updateButtons);
    draftEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }});
    sendBtn.addEventListener('click', send);
    clearBtn.addEventListener('click', clearConvo);
    changeNameBtn.addEventListener('click', ()=> askName(me || ''));
  </script>
</body>
</html>
