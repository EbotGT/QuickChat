<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuickChat â€” Supabase (v2)</title>
  <style>
    :root{--bg:#111;--panel:#17171f;--line:#2a2a35;--text:#eee;--muted:#aaa;--accent:#7ee7ff}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;display:flex;justify-content:center;padding:20px}
    .container{max-width:860px;width:100%}
    h1{margin:0 0 10px;display:flex;align-items:center;gap:10px}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:4px 10px;background:#14141e;font-size:12px}
    .dot{width:8px;height:8px;border-radius:50%;background:#ff7a7a}
    .dot.ok{background:#36d399}
    .setup{display:flex;gap:10px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
    input,textarea,button{font:inherit;padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#12121a;color:var(--text)}
    input::placeholder,textarea::placeholder{color:#777}
    button{cursor:pointer;background:#14141e}
    button:hover{background:#1a1a25}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .chip{border:1px solid var(--line);padding:6px 10px;border-radius:999px;background:#14141e}
    .chat{border:1px solid var(--line);border-radius:14px;display:flex;flex-direction:column;height:70vh;overflow:hidden;background:var(--panel)}
    .scroller{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
    .mine{align-self:flex-end;background:#dfeaff;color:#0b0b12;padding:8px 10px;border-radius:12px;max-width:75%}
    .theirs{align-self:flex-start;background:#1f1f2a;padding:8px 10px;border-radius:12px;max-width:75%}
    .meta{font-size:11px;opacity:.7;margin-bottom:4px}
    .composer{display:flex;gap:8px;padding:10px;border-top:1px solid var(--line)}
    .composer textarea{flex:1}
    .error{color:#ff7a7a;font-size:13px;margin:6px;min-height:1em}
    .small{color:var(--muted);font-size:12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;padding:20px;z-index:50}
    .panel{background:#12121a;border:1px solid var(--line);border-radius:16px;max-width:520px;width:100%;padding:16px}
  </style>
</head>
<body>
  <div class="container">
    <h1>
      QuickChat â€” Supabase (v2)
      <span class="badge"><span id="rtDot" class="dot"></span><span id="rtText">offline</span></span>
    </h1>
    <div class="setup">
      <span id="youChip" class="chip">You: <b id="meLabel">â€”</b></span>
      <button id="changeNameBtn" title="Change your name">Change</button>
      <input id="them" placeholder="Recipient name" />
      <button id="clearBtn" title="Delete this conversation from DB">Clear</button>
    </div>
    <div class="chat">
      <div class="scroller" id="scroller"><div class="small">Enter a recipient name to start chatting.</div></div>
      <div class="composer">
        <textarea id="draft" rows="2" placeholder="Type your messageâ€¦"></textarea>
        <button id="sendBtn">Send</button>
      </div>
    </div>
    <div id="error" class="error"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => { 
    const SUPABASE_URL = "https://ztxnsioiripexprudlkk.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0eG5zaW9pcmlwZXhwcnVkbGtrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0MjQ4NjYsImV4cCI6MjA3MjAwMDg2Nn0.vRB-frSRNNnMLSYOp3PR1RS1Qq4lmCwB2-KVdqRMEog";

    const themEl = document.getElementById('them');
    const draftEl = document.getElementById('draft');
    const sendBtn = document.getElementById('sendBtn');
    const clearBtn = document.getElementById('clearBtn');
    const scroller = document.getElementById('scroller');
    const errorEl = document.getElementById('error');
    const meLabel = document.getElementById('meLabel');
    const changeNameBtn = document.getElementById('changeNameBtn');
    const rtDot = document.getElementById('rtDot');
    const rtText = document.getElementById('rtText');

    let client = null;
    let me = null;
    let currentKey = '';
    let messages = [];
    let channel = null;

    const niceTime = (ts)=> new Date(ts).toLocaleString();
    const keyFor = (a,b)=> [a.trim().toLowerCase(), b.trim().toLowerCase()].sort().join('|');
    const setError = (msg)=> errorEl.textContent = msg || '';

    function setRtStatus(ok){ 
      rtDot.classList.toggle('ok', !!ok); 
      rtText.textContent = ok ? 'online' : 'offline';
    }

    function updateButtons(){
      const readyNames = !!(me && themEl.value.trim());
      sendBtn.disabled = !readyNames || !draftEl.value.trim();
      clearBtn.disabled = !readyNames;
    }

    function render(){
      scroller.innerHTML='';
      if(!messages.length){
        const d=document.createElement('div');
        d.className='small';
        d.textContent='No messages yet. Say hi! ðŸ‘‹';
        scroller.appendChild(d);
      } else {
        const meLower = me.toLowerCase();
        for(const m of messages){
          const mine = (m.sender||'').toLowerCase()===meLower;
          const bubble = document.createElement('div');
          bubble.className = mine ? 'mine':'theirs';
          const meta = document.createElement('div');
          meta.className='meta';
          meta.textContent = (mine?'You':m.sender) + ' â€¢ ' + niceTime(m.created_at);
          const text = document.createElement('div');
          text.textContent = m.body;
          bubble.appendChild(meta); bubble.appendChild(text);
          scroller.appendChild(bubble);
        }
      }
      scroller.scrollTop = scroller.scrollHeight;
      updateButtons();
    }

    async function ensureClient(){
      if(client) return true;
      try{
        client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        return true;
      }catch(e){
        setError('Failed to init Supabase client: '+ e.message);
        return false;
      }
    }

    async function reload(){
      setError('');
      if(!me || !themEl.value.trim()) { messages=[]; render(); return; }
      if(!await ensureClient()) return;
      currentKey = keyFor(me, themEl.value.trim());

      const {{ data, error }} = await client
        .from('messages').select('*')
        .eq('convo_key', currentKey)
        .order('created_at', {{ ascending: true }});
      if(error){ setError('Load error: '+ error.message); messages=[]; render(); return; }
      messages = data || [];
      render();

      if(channel){ client.removeChannel(channel); channel=null; setRtStatus(false); }
      channel = client.channel('room:'+currentKey)
        .on('postgres_changes', {{ event:'INSERT', schema:'public', table:'messages', filter:`convo_key=eq.${{currentKey}}` }}, payload=>{
          messages.push(payload.new);
          render();
        })
        .subscribe((status) => {
          setRtStatus(status === 'SUBSCRIBED');
        });
    }

    async function send(){
      setError('');
      if(!me || !themEl.value.trim() || !draftEl.value.trim()) return;
      if(!await ensureClient()) return;
      currentKey = currentKey || keyFor(me, themEl.value.trim());
      const body = draftEl.value.trim();
      const {{ error }} = await client.from('messages').insert({
        convo_key: currentKey,
        sender: me,
        recipient: themEl.value.trim(),
        body
      });
      if(error){ setError('Send failed: '+ error.message); return; }
      draftEl.value='';
      updateButtons();
    }

    async function clearConvo(){
      setError('');
      if(!me || !themEl.value.trim()) return;
      if(!await ensureClient()) return;
      if(!confirm('Clear this conversation from the database?')) return;
      const key = keyFor(me, themEl.value.trim());
      const {{ error }} = await client.from('messages').delete().eq('convo_key', key);
      if(error){ setError('Clear failed: '+ error.message); return; }
      messages=[]; render();
    }

    function askName(initial=''){
      const modal = document.createElement('div');
      modal.className='modal';
      modal.innerHTML = `
        <div class="panel">
          <div class="row" style="justify-content:space-between">
            <div style="font-weight:700">Set your name</div>
          </div>
          <div style="margin-top:8px">
            <input id="nameInput" placeholder="e.g., Ethan" value="${{initial.replace(/"/g,'&quot;')}}" style="width:100%" />
          </div>
          <div class="row" style="justify-content:flex-end;margin-top:10px">
            <button id="saveNameBtn">Save</button>
          </div>
          <div class="small" style="margin-top:6px">Saved locally so you only enter it once.</div>
        </div>`;
      document.body.appendChild(modal);
      const nameInput = modal.querySelector('#nameInput');
      const saveBtn = modal.querySelector('#saveNameBtn');
      nameInput.focus();
      function save(){
        const v = nameInput.value.trim();
        if(!v) return;
        me = v;
        localStorage.setItem('quickchat:me', me);
        meLabel.textContent = me;
        document.body.removeChild(modal);
        reload();
      }
      saveBtn.addEventListener('click', save);
      nameInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); save(); }});
    }

    function openHelpIfFirstTime(){
      const seen = localStorage.getItem('quickchat:helpSeen');
      if(seen) return;
      const modal = document.createElement('div');
      modal.className='modal';
      modal.innerHTML = `
        <div class="panel">
          <h2>Welcome to QuickChat ðŸ‘‹</h2>
          <div class="small">Steps:</div>
          <ol class="small" style="margin:6px 0 0 18px">
            <li>Set your <b>name</b> (we remember it on this device).</li>
            <li>Type the <b>recipient's name</b>.</li>
            <li>Press <b>Enter</b> to send. Shift+Enter for a new line.</li>
          </ol>
          <div class="row" style="justify-content:flex-end;margin-top:12px">
            <button id="gotItBtn">Got it</button>
          </div>
        </div>`;
      document.body.appendChild(modal);
      const close = ()=>{ localStorage.setItem('quickchat:helpSeen','1'); modal.remove(); };
      modal.querySelector('#gotItBtn').addEventListener('click', close);
      modal.addEventListener('click', (e)=>{ if(e.target===modal) close(); });
    }

    (function init(){
      me = localStorage.getItem('quickchat:me') || null;
      meLabel.textContent = me || 'â€”';
      openHelpIfFirstTime();
      if(!me){ askName(''); }
      updateButtons();
    })();

    themEl.addEventListener('input', ()=>{ reload(); updateButtons(); });
    draftEl.addEventListener('input', updateButtons);
    draftEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }});
    sendBtn.addEventListener('click', send);
    clearBtn.addEventListener('click', clearConvo);
    changeNameBtn.addEventListener('click', ()=> askName(me || ''));
  }); 
  </script>
</body>
</html>
